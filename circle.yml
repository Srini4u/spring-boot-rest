machine:
  java:
    version: oraclejdk8
  services:
    - docker
    
  environment:
    # Setting the tag for Docker-hub  | Using Circleci build number to track the deployed code incase of issues
    #TAG: $CIRCLE_BRANCH-$CIRCLE_SHA1
    TAG: $CIRCLE_BRANCH-$CIRCLE_BUILD_NUM
    DOCKER_IMAGE: $DOCKER_USER/$DOCKER_REPO_APP:$TAG 

  dependencies:
  override:
    - mvn  package install
    - docker info
    - docker build -t $DOCKER_IMAGE .

  test:
  override:
    - docker run -d --name $DOCKER_USER -p 8090:8090 $DOCKER_IMAGE; sleep 10    

  #test:
  #override:
    #- mvn  package install
    #- docker info
    #- docker build -t $DOCKER_IMAGE .
    
  deployment:
  hub:
    branch: [master, /automatic-.*/]
    commands:
      - docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS
      - docker push $DOCKER_IMAGE
